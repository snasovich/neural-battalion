name: Code Quality Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  code-quality:
    name: C# Code Quality Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Check C# files exist
      - name: Check C# Files Exist
        run: |
          echo "Checking for C# scripts..."
          SCRIPT_COUNT=$(find Assets/Scripts -name "*.cs" 2>/dev/null | wc -l)
          if [ "$SCRIPT_COUNT" -eq 0 ]; then
            echo "Error: No C# scripts found in Assets/Scripts"
            exit 1
          fi
          echo "✓ Found $SCRIPT_COUNT C# script(s)"

      # Basic C# syntax validation
      - name: Validate C# Syntax
        run: |
          echo "Checking C# syntax for common errors..."
          ERROR_COUNT=0

          while IFS= read -r -d '' file; do
            # Check for basic C# syntax requirements
            if ! grep -q "namespace" "$file"; then
              echo "⚠️  Warning: $file missing namespace declaration"
            fi

            # Check that file is not empty
            if [ ! -s "$file" ]; then
              echo "❌ Error: $file is empty"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi

            # Check for common syntax issues
            if grep -q "public class.*{$" "$file" && \
               ! grep -q "^}" "$file"; then
              echo "⚠️  Warning: $file may have formatting issues"
            fi
          done < <(find Assets/Scripts -name "*.cs" -print0)

          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "Found $ERROR_COUNT error(s)"
            exit 1
          fi

          echo "✓ Basic C# syntax validation complete"

      # Check for common code quality issues
      - name: Code Quality Analysis
        run: |
          echo "Checking for common issues..."

          # Check for TODO/FIXME comments
          echo ""
          echo "=== TODO/FIXME Comments ==="
          if find Assets/Scripts -name "*.cs" -exec grep -l "TODO\|FIXME" {} \;; then
            echo "(Found pending work items)"
          else
            echo "✓ None found"
          fi

          # Check for proper namespace usage
          echo ""
          echo "=== Checking Namespaces ==="
          FILES_WITHOUT_NS=$(find Assets/Scripts -name "*.cs" \
            -exec grep -L "namespace NeuralBattalion" {} \;)
          if [ -n "$FILES_WITHOUT_NS" ]; then
            echo "⚠️  Files without NeuralBattalion namespace:"
            echo "$FILES_WITHOUT_NS"
          else
            echo "✓ All files use proper namespaces"
          fi

          # Check for consistent using statements
          echo ""
          echo "=== Common Using Statements ==="
          find Assets/Scripts -name "*.cs" -exec grep -h "^using " {} \; | \
            sort | uniq -c | sort -rn | head -5

          echo ""
          echo "✓ Code quality analysis complete"

      # Check file formatting
      - name: Check File Formatting
        run: |
          echo "Checking file formatting..."

          # Check for Windows line endings (CRLF)
          echo ""
          echo "=== Line Endings ==="
          if find Assets/Scripts -name "*.cs" -exec file {} \; | \
             grep -q CRLF; then
            echo "⚠️  Some files have Windows line endings (CRLF)"
            find Assets/Scripts -name "*.cs" -exec file {} \; | \
              grep CRLF | head -5
          else
            echo "✓ All files have Unix line endings (LF)"
          fi

          # Check for trailing whitespace
          echo ""
          echo "=== Trailing Whitespace ==="
          if grep -r " $" Assets/Scripts --include="*.cs" -l; then
            echo "⚠️  Files with trailing whitespace (above)"
          else
            echo "✓ No trailing whitespace found"
          fi

          echo ""
          echo "✓ File formatting check complete"

      # Summary
      - name: Summary
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "✅ All code quality checks passed!"
          echo "=========================================="
          echo ""
          echo "What was checked:"
          echo "  • C# script existence and structure"
          echo "  • Basic syntax validation"
          echo "  • Namespace conventions"
          echo "  • File formatting"
          echo ""
          echo "Note: Full compilation requires Unity Editor."
          echo ""
          echo "To test full compilation locally:"
          echo "  1. Open project in Unity Editor"
          echo "  2. Check Console for compilation errors"
